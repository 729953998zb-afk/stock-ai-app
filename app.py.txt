import streamlit as st
import pandas as pd
import akshare as ak
import plotly.graph_objects as go
from datetime import datetime
import os

# ================= é…ç½®åŒºåŸŸ =================
# 1. è®¾ç½®é¡µé¢
st.set_page_config(page_title="Aè‚¡ç½—ç›˜ Pro | AIé©±åŠ¨", layout="wide", page_icon="ğŸ“ˆ")

# 2. å¤§æ¨¡å‹é…ç½® (è¿™é‡Œä»¥ OpenAI æ ¼å¼ä¸ºä¾‹ï¼Œå¯å…¼å®¹ DeepSeek/Moonshot/ç™¾åº¦)
# å¦‚æœä½ æœ‰ API Keyï¼Œå¹¶å°† USE_REAL_AI æ”¹ä¸º True
USE_REAL_AI = True  # âš ï¸ æ”¹ä¸º True å¯ç”¨çœŸå® AI
API_KEY = "sk-729953998" 
BASE_URL = "https://api.openai.com/v1" # æˆ– DeepSeek/ç™¾åº¦ çš„ Base URL

# ================= æ ¸å¿ƒåŠŸèƒ½å‡½æ•° =================

# 1. è·å–çœŸå®å¤§ç›˜æ•°æ® (AkShare)
@st.cache_data(ttl=300) # ç¼“å­˜5åˆ†é’Ÿ
def get_market_index():
    try:
        # è·å–ä¸Šè¯æŒ‡æ•°å®æ—¶æ•°æ®
        stock_zh_index_spot_df = ak.stock_zh_index_spot()
        # ç­›é€‰ä¸Šè¯æŒ‡æ•°
        sh_index = stock_zh_index_spot_df[stock_zh_index_spot_df['åç§°'] == 'ä¸Šè¯æŒ‡æ•°'].iloc[0]
        return sh_index
    except:
        return None

# 2. è·å–å®æ—¶ä¸ªè‚¡æ•°æ®
def get_stock_price(symbol):
    try:
        # ç¤ºä¾‹ï¼šè·å–ä¸ªè‚¡è¡Œæƒ…
        df = ak.stock_zh_a_spot_em()
        stock = df[df['ä»£ç '] == symbol].iloc[0]
        return stock
    except:
        return None

# 3. è·å–æœ€æ–°è´¢ç»æ–°é—»
@st.cache_data(ttl=600)
def get_latest_news():
    try:
        # è·å–ä¸œæ–¹è´¢å¯Œçš„å³æ—¶è´¢ç»æ–°é—»
        news_df = ak.stock_info_global_cls_em() # è´¢è”ç¤¾ç”µæŠ¥
        return news_df.head(10) # å–å‰10æ¡
    except:
        return pd.DataFrame()

# 4. AI åˆ†ææ¨¡å— (æ ¸å¿ƒ)
def analyze_news_with_ai(news_content):
    if not USE_REAL_AI:
        # æ¨¡æ‹Ÿ AI è¿”å› (ç”¨äºæ¼”ç¤º)
        import random
        sentiments = ["åˆ©å¥½ ğŸ”´", "åˆ©ç©º ğŸŸ¢", "ä¸­æ€§ âšªï¸"]
        analysis = f"ã€AIæ¨¡æ‹Ÿåˆ†æã€‘ï¼šæ£€æµ‹åˆ°å…³é”®è¯ä¸æ”¿ç­–å¼ºç›¸å…³ã€‚å»ºè®®å…³æ³¨æ¿å—èµ„é‡‘æµå‘ã€‚({random.choice(sentiments)})"
        return analysis

    # --- çœŸå® AI è°ƒç”¨ä»£ç  ---
    from openai import OpenAI
    client = OpenAI(api_key=API_KEY, base_url=BASE_URL)
    
    prompt = f"""
    ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„Aè‚¡åˆ†æå¸ˆã€‚è¯·åˆ†æä»¥ä¸‹æ–°é—»å¯¹ä¸­å›½è‚¡å¸‚çš„å½±å“ï¼š
    æ–°é—»å†…å®¹ï¼š{news_content}
    
    è¯·è¾“å‡ºï¼š
    1. æƒ…æ„Ÿåˆ¤æ–­ï¼š[åˆ©å¥½/åˆ©ç©º/ä¸­æ€§]
    2. å½±å“æ¿å—ï¼š[å…·ä½“è¡Œä¸š]
    3. ç®€çŸ­ç‚¹è¯„ï¼ˆ50å­—ä»¥å†…ï¼‰ã€‚
    """
    
    try:
        response = client.chat.completions.create(
            model="gpt-3.5-turbo", # æˆ– deepseek-chat
            messages=[{"role": "user", "content": prompt}],
            temperature=0.3
        )
        return response.choices[0].message.content
    except Exception as e:
        return f"AIåˆ†æå¤±è´¥: {str(e)}"

# ================= é¡µé¢ UI é€»è¾‘ =================

# --- ä¾§è¾¹æ ï¼šå®è§‚é©¾é©¶èˆ± ---
with st.sidebar:
    st.title("ğŸ§­ Aè‚¡ç½—ç›˜ Pro")
    st.caption("æ•°æ®æºï¼šAkShare | åˆ†æï¼šLLM")
    
    st.divider()
    st.header("ğŸŒ å®æ—¶å¤§ç›˜")
    
    index_data = get_market_index()
    if index_data is not None:
        c1, c2 = st.columns(2)
        idx_val = index_data['æœ€æ–°ä»·']
        idx_change = index_data['æ¶¨è·Œé¢']
        idx_pct = index_data['æ¶¨è·Œå¹…']
        
        color = "normal" if idx_change >= 0 else "inverse"
        st.metric("ä¸Šè¯æŒ‡æ•°", f"{idx_val}", f"{idx_pct}%", delta_color=color)
        st.metric("æˆäº¤é¢", f"{index_data['æˆäº¤é¢']/100000000:.1f}äº¿", "å®æ—¶")
    else:
        st.warning("æ•°æ®æ¥å£è¿æ¥è¶…æ—¶")

    st.info("ğŸ’¡ æç¤ºï¼šç‚¹å‡»å³ä¸Šè§’ 'Deploy' å¯åˆ†äº«ç»™æœ‹å‹")

# --- ä¸»ç•Œé¢ ---
st.header("ğŸ¤– AI æ™ºèƒ½é€‰è‚¡åˆ†æç³»ç»Ÿ")

tab1, tab2, tab3 = st.tabs(["âš¡ï¸ çŸ­çº¿çˆ†å‘ (AIèˆ†æƒ…)", "ğŸ›¡ï¸ é•¿çº¿ä¼˜è´¨ (åŸºæœ¬é¢)", "ğŸ” æŸ¥ä¸ªè‚¡"])

# === æ¨¡å—1ï¼šçŸ­çº¿çˆ†å‘ (ç»“åˆæ–°é—» + AI) ===
with tab1:
    st.subheader("ğŸ”¥ å®æ—¶èˆ†æƒ…é£å£ (AkShare + AI)")
    st.markdown("è‡ªåŠ¨æŠ“å–æœ€æ–°è´¢ç»ç”µæŠ¥ï¼Œå¹¶åˆ©ç”¨å¤§æ¨¡å‹åˆ†æåˆ©å¥½åˆ©ç©ºã€‚")
    
    if st.button("ğŸ”„ åˆ·æ–°æœ€æ–°æ–°é—»"):
        st.cache_data.clear()
        st.rerun()
    
    news_df = get_latest_news()
    
    if not news_df.empty:
        for index, row in news_df.iterrows():
            with st.container(border=True):
                col_news, col_ai = st.columns([3, 2])
                
                with col_news:
                    time_str = row['å‘å¸ƒæ—¶é—´']
                    content = row['å†…å®¹']
                    st.markdown(f"**â° {time_str}**")
                    st.write(content)
                
                with col_ai:
                    if st.button(f"ğŸ¤– AI åˆ†æå½±å“", key=f"btn_{index}"):
                        with st.spinner("AI æ­£åœ¨è¯»å–æ–°é—»å¹¶æ¨æ¼”èµ„é‡‘æµå‘..."):
                            analysis_result = analyze_news_with_ai(content)
                            st.markdown(analysis_result)
                    else:
                        st.caption("ç‚¹å‡»æŒ‰é’®è®©AIåˆ†ææ­¤æ¶ˆæ¯å¯¹è‚¡å¸‚çš„å½±å“")
    else:
        st.error("æš‚æœªè·å–åˆ°æ–°é—»æ•°æ®ï¼Œè¯·ç¨ååˆ·æ–°")

# === æ¨¡å—2ï¼šé•¿çº¿ä¼˜è´¨ (åŸºæœ¬é¢ç­›é€‰) ===
with tab2:
    st.subheader("ğŸ›¡ï¸ æ ¸å¿ƒèµ„äº§æ± ")
    st.markdown("è¿™é‡Œé¢„è®¾äº†ä¸€äº›ç¬¦åˆé«˜ROEã€ä½ä¼°å€¼æ ‡å‡†çš„ä¼˜è´¨è‚¡ï¼Œå®æ—¶æ‹‰å–ç°ä»·ã€‚")
    
    # è¿™é‡Œå®šä¹‰ä½ çš„é•¿çº¿è‚¡ç¥¨æ±  (ç¤ºä¾‹)
    long_term_stocks = [
        {"code": "600519", "name": "è´µå·èŒ…å°"},
        {"code": "601318", "name": "ä¸­å›½å¹³å®‰"},
        {"code": "300750", "name": "å®å¾·æ—¶ä»£"},
        {"code": "600036", "name": "æ‹›å•†é“¶è¡Œ"},
        {"code": "601857", "name": "ä¸­å›½çŸ³æ²¹"} # ä¸­ç‰¹ä¼°
    ]
    
    col1, col2, col3 = st.columns(3)
    
    for i, stock in enumerate(long_term_stocks):
        real_data = get_stock_price(stock['code'])
        
        # è½®æµæ”¾å…¥åˆ—ä¸­
        with [col1, col2, col3][i % 3]:
            with st.container(border=True):
                if real_data is not None:
                    name = real_data['åç§°']
                    price = real_data['æœ€æ–°ä»·']
                    pct = real_data['æ¶¨è·Œå¹…']
                    vol = real_data['æˆäº¤é‡']
                    
                    st.metric(name, f"Â¥{price}", f"{pct}%")
                    st.caption(f"ä»£ç : {stock['code']}")
                    
                    # ç®€å•çš„é€»è¾‘åˆ¤æ–­
                    if pct > 0:
                        st.markdown("ğŸ”´ **è¶‹åŠ¿ï¼š** èµ„é‡‘æµå…¥ï¼Œç»´æŒå¤šå¤´ã€‚")
                    else:
                        st.markdown("ğŸŸ¢ **è¶‹åŠ¿ï¼š** å›è°ƒéœ‡è¡ï¼Œå…³æ³¨æ”¯æ’‘ã€‚")
                else:
                    st.write(f"{stock['name']} æ•°æ®åŠ è½½å¤±è´¥")

# === æ¨¡å—3ï¼šä¸ªè‚¡æŸ¥è¯¢ ===
with tab3:
    st.subheader("ğŸ” ä¸ªè‚¡æ·±åº¦è¯Šæ–­")
    symbol_input = st.text_input("è¯·è¾“å…¥è‚¡ç¥¨ä»£ç  (å¦‚ 000001)", "")
    
    if symbol_input:
        stock_info = get_stock_price(symbol_input)
        if stock_info is not None:
            c1, c2, c3 = st.columns(3)
            c1.metric("åç§°", stock_info['åç§°'])
            c2.metric("æœ€æ–°ä»·", stock_info['æœ€æ–°ä»·'], f"{stock_info['æ¶¨è·Œå¹…']}%")
            c3.metric("æ¢æ‰‹ç‡", f"{stock_info['æ¢æ‰‹ç‡']}%")
            
            st.info(f"æœ€é«˜: {stock_info['æœ€é«˜']} | æœ€ä½: {stock_info['æœ€ä½']} | æˆäº¤é¢: {float(stock_info['æˆäº¤é¢'])/1e8:.2f}äº¿")
            
            # è¿™é‡Œå¯ä»¥æ¥å…¥ Tushare çš„è´¢åŠ¡æ•°æ®æ¥å£
            st.markdown("### ğŸ“ˆ AI ç»¼åˆå»ºè®®")
            st.write("ç»“åˆå½“å‰å®è§‚ç¯å¢ƒä¸ä¸ªè‚¡èµ°åŠ¿ï¼ŒAIæ¨¡å‹æ­£åœ¨è®¡ç®—...")
            st.markdown(analyze_news_with_ai(f"{stock_info['åç§°']} ä»Šæ—¥è‚¡ä»·è¡¨ç°ä¸º {stock_info['æ¶¨è·Œå¹…']}%ï¼Œæ¢æ‰‹ç‡ {stock_info['æ¢æ‰‹ç‡']}%ã€‚"))
            
        else:
            st.error("æœªæ‰¾åˆ°è¯¥è‚¡ç¥¨ä»£ç ï¼Œè¯·è¾“å…¥æ­£ç¡®çš„6ä½ä»£ç ")